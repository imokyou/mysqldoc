# MySQL 权限管理

## 概述

MySQL权限管理是数据库安全的重要组成部分，通过合理的权限分配可以确保数据安全，防止未授权访问。MySQL提供了细粒度的权限控制机制，支持全局、数据库、表、列等多个级别的权限管理。

## 权限分类

### 1. 按权限级别分类

#### 1.1 全局权限（Global Privileges）
- 影响所有数据库和表
- 包括：CREATE USER、RELOAD、SHUTDOWN、PROCESS等
- 授予语法：`GRANT privilege ON *.* TO user`

#### 1.2 数据库权限（Database Privileges）
- 影响指定数据库的所有表
- 包括：CREATE、DROP、ALTER、INDEX等
- 授予语法：`GRANT privilege ON database.* TO user`

#### 1.3 表权限（Table Privileges）
- 影响指定表
- 包括：SELECT、INSERT、UPDATE、DELETE等
- 授予语法：`GRANT privilege ON database.table TO user`

#### 1.4 列权限（Column Privileges）
- 影响指定表的指定列
- 包括：SELECT、INSERT、UPDATE
- 授予语法：`GRANT privilege(column) ON database.table TO user`

### 2. 按操作类型分类

#### 2.1 数据操作权限
```sql
-- 查询权限
GRANT SELECT ON database.* TO 'user'@'host';

-- 插入权限
GRANT INSERT ON database.* TO 'user'@'host';

-- 更新权限
GRANT UPDATE ON database.* TO 'user'@'host';

-- 删除权限
GRANT DELETE ON database.* TO 'user'@'host';
```

#### 2.2 结构操作权限
```sql
-- 创建表权限
GRANT CREATE ON database.* TO 'user'@'host';

-- 修改表结构权限
GRANT ALTER ON database.* TO 'user'@'host';

-- 删除表权限
GRANT DROP ON database.* TO 'user'@'host';

-- 创建索引权限
GRANT INDEX ON database.* TO 'user'@'host';
```

#### 2.3 管理权限
```sql
-- 创建用户权限
GRANT CREATE USER ON *.* TO 'admin'@'localhost';

-- 重载权限（重新加载权限表）
GRANT RELOAD ON *.* TO 'admin'@'localhost';

-- 关闭服务器权限
GRANT SHUTDOWN ON *.* TO 'admin'@'localhost';

-- 查看进程权限
GRANT PROCESS ON *.* TO 'admin'@'localhost';
```

## 授权语法

### 1. 基本授权语法

```sql
GRANT privilege_type [(column_list)]
    ON object_type object_name
    TO user_specification [, user_specification] ...
    [WITH GRANT OPTION]
    [AS user [WITH ROLE role]]
```

### 2. 权限类型说明

#### 2.1 常用权限类型
- **ALL PRIVILEGES**：所有权限
- **SELECT**：查询权限
- **INSERT**：插入权限
- **UPDATE**：更新权限
- **DELETE**：删除权限
- **CREATE**：创建权限
- **DROP**：删除权限
- **ALTER**：修改权限
- **INDEX**：索引权限
- **REFERENCES**：外键权限
- **CREATE TEMPORARY TABLES**：创建临时表权限
- **LOCK TABLES**：锁定表权限
- **EXECUTE**：执行存储过程权限
- **CREATE VIEW**：创建视图权限
- **SHOW VIEW**：查看视图权限
- **CREATE ROUTINE**：创建存储过程权限
- **ALTER ROUTINE**：修改存储过程权限
- **EVENT**：事件权限
- **TRIGGER**：触发器权限

### 3. 授权示例

#### 3.1 授予数据库权限
```sql
-- 授予用户对test数据库的所有权限
GRANT ALL PRIVILEGES ON test.* TO 'testuser'@'localhost';

-- 授予用户对test数据库的查询和插入权限
GRANT SELECT, INSERT ON test.* TO 'testuser'@'localhost';
```

#### 3.2 授予表权限
```sql
-- 授予用户对特定表的查询权限
GRANT SELECT ON test.users TO 'readonly'@'localhost';

-- 授予用户对特定表的增删改查权限
GRANT SELECT, INSERT, UPDATE, DELETE ON test.orders TO 'operator'@'localhost';
```

#### 3.3 授予列权限
```sql
-- 授予用户对特定列的查询权限
GRANT SELECT(id, name, email) ON test.users TO 'limited'@'localhost';

-- 授予用户对特定列的更新权限
GRANT UPDATE(name, email) ON test.users TO 'editor'@'localhost';
```

#### 3.4 授予全局权限
```sql
-- 授予用户创建用户的权限
GRANT CREATE USER ON *.* TO 'admin'@'localhost';

-- 授予用户查看所有进程的权限
GRANT PROCESS ON *.* TO 'monitor'@'localhost';
```

## 权限管理操作

### 1. 查看权限

#### 1.1 查看当前用户权限
```sql
-- 查看当前用户权限
SHOW GRANTS;

-- 查看指定用户权限
SHOW GRANTS FOR 'user'@'host';
```

#### 1.2 查看权限表
```sql
-- 查看用户表
SELECT * FROM mysql.user;

-- 查看数据库权限表
SELECT * FROM mysql.db;

-- 查看表权限表
SELECT * FROM mysql.tables_priv;

-- 查看列权限表
SELECT * FROM mysql.columns_priv;
```

### 2. 撤销权限

#### 2.1 撤销权限语法
```sql
REVOKE privilege_type [(column_list)]
    ON object_type object_name
    FROM user_specification [, user_specification] ...
```

#### 2.2 撤销权限示例
```sql
-- 撤销用户对test数据库的所有权限
REVOKE ALL PRIVILEGES ON test.* FROM 'testuser'@'localhost';

-- 撤销用户对特定表的删除权限
REVOKE DELETE ON test.users FROM 'operator'@'localhost';

-- 撤销用户对特定列的更新权限
REVOKE UPDATE(name) ON test.users FROM 'editor'@'localhost';
```

### 3. 权限继承

#### 3.1 WITH GRANT OPTION
```sql
-- 授予用户权限并允许其授予给其他用户
GRANT SELECT ON test.* TO 'manager'@'localhost' WITH GRANT OPTION;
```

#### 3.2 角色权限
```sql
-- 创建角色
CREATE ROLE 'readonly_role';

-- 为角色授予权限
GRANT SELECT ON *.* TO 'readonly_role';

-- 将角色授予用户
GRANT 'readonly_role' TO 'user'@'localhost';

-- 激活角色
SET DEFAULT ROLE 'readonly_role' TO 'user'@'localhost';
```

## 权限最佳实践

### 1. 最小权限原则

#### 1.1 权限分配策略
- 只授予用户完成工作所需的最小权限
- 定期审查用户权限，撤销不必要的权限
- 使用角色来管理权限，而不是直接授予用户

#### 1.2 权限分类示例
```sql
-- 只读用户
GRANT SELECT ON database.* TO 'readonly'@'localhost';

-- 应用用户（增删改查）
GRANT SELECT, INSERT, UPDATE, DELETE ON database.* TO 'app'@'localhost';

-- 管理员用户
GRANT ALL PRIVILEGES ON database.* TO 'admin'@'localhost';
```

### 2. 安全配置

#### 2.1 主机限制
```sql
-- 限制用户只能从特定主机连接
GRANT SELECT ON test.* TO 'user'@'192.168.1.%';

-- 限制用户只能从本地连接
GRANT SELECT ON test.* TO 'user'@'localhost';
```

#### 2.2 密码策略
```sql
-- 设置密码过期时间
ALTER USER 'user'@'localhost' PASSWORD EXPIRE INTERVAL 90 DAY;

-- 设置密码复杂度要求
SET GLOBAL validate_password.policy=MEDIUM;
```

### 3. 权限监控

#### 3.1 权限审计
```sql
-- 查看所有用户及其权限
SELECT 
    u.User, 
    u.Host, 
    GROUP_CONCAT(DISTINCT p.Privilege) as Privileges
FROM mysql.user u
LEFT JOIN mysql.user p ON u.User = p.User
GROUP BY u.User, u.Host;
```

#### 3.2 异常权限检测
```sql
-- 查找具有过多权限的用户
SELECT User, Host, 
       COUNT(*) as privilege_count
FROM mysql.user 
WHERE User != 'root' 
GROUP BY User, Host 
HAVING privilege_count > 10;
```

## 常见问题与解决方案

### 1. 权限问题诊断

#### 1.1 权限检查步骤
1. 确认用户存在：`SELECT User, Host FROM mysql.user;`
2. 确认权限存在：`SHOW GRANTS FOR 'user'@'host';`
3. 确认连接来源：检查Host字段是否匹配
4. 确认密码正确：重新设置密码

#### 1.2 常见错误
```sql
-- 错误：Access denied for user
-- 解决：检查用户权限和密码

-- 错误：Host is not allowed to connect
-- 解决：检查Host字段和网络配置

-- 错误：Table doesn't exist
-- 解决：检查数据库和表是否存在
```

### 2. 权限恢复

#### 2.1 重置root密码
```sql
-- 方法1：使用mysql_secure_installation
mysql_secure_installation

-- 方法2：安全模式重置
mysqld_safe --skip-grant-tables &
mysql -u root
UPDATE mysql.user SET authentication_string=PASSWORD('new_password') WHERE User='root';
FLUSH PRIVILEGES;
```

#### 2.2 重建权限表
```sql
-- 重新加载权限表
FLUSH PRIVILEGES;

-- 重新安装权限表（谨慎使用）
mysql_install_db
```

## 总结

MySQL权限管理是数据库安全的核心，通过合理的权限分配和监控，可以有效保护数据安全。关键要点包括：

1. **最小权限原则**：只授予必要的权限
2. **定期审查**：定期检查和清理权限
3. **角色管理**：使用角色简化权限管理
4. **安全配置**：限制连接来源和密码策略
5. **监控审计**：建立权限监控和审计机制

通过以上措施，可以构建一个安全可靠的MySQL权限管理体系。 