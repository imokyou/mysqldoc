# 7.3 MySQL 复制配置

## 目录
- [1. 概述](#1-概述)
- [2. 主库配置](#2-主库配置)
- [3. 从库配置](#4-从库配置)
- [4. 用户创建](#4-用户创建)
- [5. 复制启动](#5-复制启动)
- [6. 配置验证](#6-配置验证)
- [7. 常见配置参数](#7-常见配置参数)
- [8. 实际应用示例](#8-实际应用示例)

## 1. 概述

MySQL复制配置是建立主从复制环境的关键步骤，包括主库和从库的配置、用户权限设置、复制启动等。

### 1.1 配置流程

```mermaid
graph TD
    A[准备环境] --> B[主库配置]
    B --> C[从库配置]
    C --> D[创建复制用户]
    D --> E[获取主库状态]
    E --> F[从库启动复制]
    F --> G[验证复制状态]
```

### 1.2 配置要点

- **server_id唯一性**：每个MySQL实例必须有唯一的server_id
- **二进制日志开启**：主库必须开启二进制日志
- **网络连通性**：主从库之间网络必须连通
- **用户权限**：复制用户需要REPLICATION SLAVE权限

## 2. 主库配置

### 2.1 配置文件设置

主库需要在`my.cnf`或`my.ini`中添加以下配置：

```ini
[mysqld]
# 服务器唯一标识
server_id = 1

# 开启二进制日志
log_bin = mysql-bin
log_bin_index = mysql-bin.index

# 二进制日志格式
binlog_format = ROW

# 二进制日志保留天数
expire_logs_days = 7

# 同步到磁盘
sync_binlog = 1

# InnoDB事务日志
innodb_flush_log_at_trx_commit = 1

# 字符集设置
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci
```

### 2.2 配置参数说明

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| server_id | 服务器唯一标识 | 1-4294967295 |
| log_bin | 二进制日志文件名 | mysql-bin |
| binlog_format | 日志格式 | ROW/STATEMENT/MIXED |
| expire_logs_days | 日志保留天数 | 7-30 |
| sync_binlog | 同步到磁盘 | 1 |

### 2.3 重启主库

```bash
# Linux系统
sudo systemctl restart mysql

# Windows系统
net stop mysql
net start mysql
```

## 3. 从库配置

### 3.1 配置文件设置

从库需要在`my.cnf`或`my.ini`中添加以下配置：

```ini
[mysqld]
# 服务器唯一标识
server_id = 2

# 开启中继日志
relay_log = mysql-relay-bin
relay_log_index = mysql-relay-bin.index

# 从库更新日志
log_slave_updates = 1

# 只读模式（可选）
read_only = 1
super_read_only = 1

# 字符集设置
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci

# 复制相关参数
relay_log_recovery = 1
slave_skip_errors = 1062
```

### 3.2 配置参数说明

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| server_id | 服务器唯一标识 | 与主库不同 |
| relay_log | 中继日志文件名 | mysql-relay-bin |
| log_slave_updates | 记录从库更新 | 1 |
| read_only | 只读模式 | 1 |
| relay_log_recovery | 中继日志恢复 | 1 |

### 3.3 重启从库

```bash
# Linux系统
sudo systemctl restart mysql

# Windows系统
net stop mysql
net start mysql
```

## 4. 用户创建

### 4.1 创建复制用户

在主库上创建用于复制的用户：

```sql
-- 创建复制用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'repl_password';

-- 授予复制权限
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 4.2 权限验证

```sql
-- 查看用户权限
SHOW GRANTS FOR 'repl'@'%';

-- 测试连接
mysql -h master_host -u repl -p
```

### 4.3 安全建议

```sql
-- 限制用户访问来源
CREATE USER 'repl'@'192.168.1.%' IDENTIFIED BY 'repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.1.%';

-- 使用强密码
CREATE USER 'repl'@'%' IDENTIFIED BY 'StrongPassword123!';
```

## 5. 复制启动

### 5.1 获取主库状态

在主库上执行：

```sql
-- 查看主库状态
SHOW MASTER STATUS;

-- 输出示例
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |      154 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
```

### 5.2 从库启动复制

在从库上执行：

```sql
-- 停止复制（如果已启动）
STOP SLAVE;

-- 重置复制
RESET SLAVE ALL;

-- 配置复制
CHANGE MASTER TO
    MASTER_HOST = '192.168.1.100',
    MASTER_PORT = 3306,
    MASTER_USER = 'repl',
    MASTER_PASSWORD = 'repl_password',
    MASTER_LOG_FILE = 'mysql-bin.000001',
    MASTER_LOG_POS = 154;

-- 启动复制
START SLAVE;
```

### 5.3 基于GTID的复制

```sql
-- 启用GTID
SET GLOBAL gtid_mode = ON;
SET GLOBAL enforce_gtid_consistency = ON;

-- 配置GTID复制
CHANGE MASTER TO
    MASTER_HOST = '192.168.1.100',
    MASTER_PORT = 3306,
    MASTER_USER = 'repl',
    MASTER_PASSWORD = 'repl_password',
    MASTER_AUTO_POSITION = 1;
```

## 6. 配置验证

### 6.1 检查复制状态

```sql
-- 查看从库状态
SHOW SLAVE STATUS\G

-- 重要字段说明
-- Slave_IO_Running: Yes (I/O线程运行正常)
-- Slave_SQL_Running: Yes (SQL线程运行正常)
-- Seconds_Behind_Master: 0 (无延迟)
-- Last_Error: (无错误)
```

### 6.2 测试复制功能

```sql
-- 在主库上创建测试数据
USE test;
CREATE TABLE test_replication (
    id INT PRIMARY KEY,
    name VARCHAR(50)
);
INSERT INTO test_replication VALUES (1, 'test');

-- 在从库上验证数据
USE test;
SELECT * FROM test_replication;
```

### 6.3 监控复制延迟

```sql
-- 查看复制延迟
SHOW SLAVE STATUS\G

-- 监控脚本
SELECT 
    MASTER_HOST,
    MASTER_PORT,
    SLAVE_IO_RUNNING,
    SLAVE_SQL_RUNNING,
    SECONDS_BEHIND_MASTER,
    LAST_ERROR
FROM performance_schema.replication_connection_status;
```

## 7. 常见配置参数

### 7.1 主库参数

```ini
# 二进制日志相关
log_bin = mysql-bin
binlog_format = ROW
sync_binlog = 1
expire_logs_days = 7

# 复制过滤
binlog_do_db = db1,db2
binlog_ignore_db = mysql,information_schema

# 性能优化
innodb_flush_log_at_trx_commit = 1
```

### 7.2 从库参数

```ini
# 中继日志相关
relay_log = mysql-relay-bin
relay_log_recovery = 1

# 复制过滤
replicate_do_db = db1,db2
replicate_ignore_db = mysql,information_schema

# 错误处理
slave_skip_errors = 1062,1032
```

### 7.3 网络配置

```ini
# 连接超时
connect_timeout = 10
net_read_timeout = 30
net_write_timeout = 60

# 最大连接数
max_connections = 1000
```

## 8. 实际应用示例

### 8.1 单主单从配置

```bash
# 主库配置 (192.168.1.100)
[mysqld]
server_id = 1
log_bin = mysql-bin
binlog_format = ROW

# 从库配置 (192.168.1.101)
[mysqld]
server_id = 2
relay_log = mysql-relay-bin
read_only = 1
```

### 8.2 一主多从配置

```bash
# 主库配置
[mysqld]
server_id = 1
log_bin = mysql-bin
binlog_format = ROW

# 从库1配置
[mysqld]
server_id = 2
relay_log = mysql-relay-bin

# 从库2配置
[mysqld]
server_id = 3
relay_log = mysql-relay-bin
```

### 8.3 链式复制配置

```bash
# 主库配置
[mysqld]
server_id = 1
log_bin = mysql-bin

# 中间从库配置
[mysqld]
server_id = 2
relay_log = mysql-relay-bin
log_slave_updates = 1
log_bin = mysql-bin

# 最终从库配置
[mysqld]
server_id = 3
relay_log = mysql-relay-bin
```

### 8.4 配置脚本示例

```bash
#!/bin/bash
# 主库配置脚本

# 备份原配置
cp /etc/mysql/my.cnf /etc/mysql/my.cnf.backup

# 添加复制配置
cat >> /etc/mysql/my.cnf << EOF
[mysqld]
server_id = 1
log_bin = mysql-bin
binlog_format = ROW
sync_binlog = 1
expire_logs_days = 7
EOF

# 重启MySQL
systemctl restart mysql

# 创建复制用户
mysql -u root -p << EOF
CREATE USER 'repl'@'%' IDENTIFIED BY 'repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
EOF
```

### 8.5 自动化配置工具

```python
#!/usr/bin/env python3
# MySQL复制配置自动化脚本

import mysql.connector
import subprocess
import sys

def configure_master(host, user, password, server_id):
    """配置主库"""
    config = {
        'server_id': server_id,
        'log_bin': 'mysql-bin',
        'binlog_format': 'ROW',
        'sync_binlog': 1,
        'expire_logs_days': 7
    }
    
    # 更新配置文件
    update_config_file('/etc/mysql/my.cnf', config)
    
    # 重启MySQL
    subprocess.run(['systemctl', 'restart', 'mysql'])
    
    # 创建复制用户
    create_replication_user(host, user, password)

def configure_slave(host, user, password, server_id, master_host):
    """配置从库"""
    config = {
        'server_id': server_id,
        'relay_log': 'mysql-relay-bin',
        'read_only': 1
    }
    
    # 更新配置文件
    update_config_file('/etc/mysql/my.cnf', config)
    
    # 重启MySQL
    subprocess.run(['systemctl', 'restart', 'mysql'])
    
    # 启动复制
    start_replication(host, user, password, master_host)

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python3 configure_replication.py [master|slave]")
        sys.exit(1)
    
    mode = sys.argv[1]
    
    if mode == 'master':
        configure_master('localhost', 'root', 'password', 1)
    elif mode == 'slave':
        configure_slave('localhost', 'root', 'password', 2, '192.168.1.100')
    else:
        print("Invalid mode. Use 'master' or 'slave'")
```

## 总结

MySQL复制配置是建立高可用数据库环境的基础，需要：

1. **正确配置主从库参数**
2. **创建合适的复制用户**
3. **验证网络连通性**
4. **监控复制状态**
5. **定期备份配置**

通过合理的配置和监控，可以建立稳定可靠的MySQL复制环境。 

**[返回目录 README.md](./README.md)** 