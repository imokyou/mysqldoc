# MySQL 错误日志详解

## 概述

错误日志是MySQL最重要的日志之一，记录了MySQL服务器运行过程中的错误信息、警告信息和重要事件。通过分析错误日志，可以及时发现和解决数据库问题。

## 错误日志架构

```
┌─────────────────────────────────────────────────────────────┐
│                       错误日志系统                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   启动错误   │ │   运行错误   │ │   关闭错误   │          │
│  │   Startup  │ │   Runtime   │ │  Shutdown  │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   配置错误   │ │   权限错误   │ │   连接错误   │          │
│  │   Config    │ │  Privilege  │ │ Connection │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 1. 错误日志配置

### 1.1 基本配置

```sql
-- 查看错误日志配置
SHOW VARIABLES LIKE 'log_error';

-- 查看错误日志级别
SHOW VARIABLES LIKE 'log_error_verbosity';
```

### 1.2 配置文件设置

```ini
# my.cnf 配置文件
[mysqld]
# 错误日志文件路径
log_error = /var/log/mysql/error.log

# 错误日志级别 (1=ERROR, 2=ERROR+WARNING, 3=ERROR+WARNING+NOTE)
log_error_verbosity = 2

# 错误日志轮转大小
log_error_services = 'log_filter_internal; log_sink_internal'
```

### 1.3 动态配置

```sql
-- 设置错误日志级别
SET GLOBAL log_error_verbosity = 2;

-- 查看当前错误日志文件
SHOW VARIABLES LIKE 'log_error';
```

## 2. 错误日志内容

### 2.1 日志格式

```
时间戳 [级别] [进程ID] [线程ID] [源文件:行号] 错误信息
```

#### 示例日志条目

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-000067] [Server] unknown variable 'max_connections=1000'
2024-01-15T10:30:45.123457Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.
2024-01-15T10:30:45.123458Z 0 [Note] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections.
```

### 2.2 错误级别

| 级别 | 说明 | 示例 |
|------|------|------|
| **ERROR** | 严重错误，影响服务运行 | 启动失败、配置错误 |
| **WARNING** | 警告信息，不影响服务 | 配置建议、性能警告 |
| **NOTE** | 一般信息 | 服务启动、连接信息 |

## 3. 常见错误类型

### 3.1 启动错误

#### 3.1.1 配置文件错误

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-000067] [Server] unknown variable 'max_connections=1000'
```

**解决方案**：
```sql
-- 检查配置参数名是否正确
SHOW VARIABLES LIKE 'max_connections';

-- 修正配置文件
# my.cnf
[mysqld]
max_connections = 1000
```

#### 3.1.2 权限错误

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-010119] [Server] Can't create/write to file '/var/log/mysql/error.log'
```

**解决方案**：
```bash
# 检查文件权限
ls -la /var/log/mysql/error.log

# 修改权限
chown mysql:mysql /var/log/mysql/error.log
chmod 644 /var/log/mysql/error.log
```

### 3.2 运行错误

#### 3.2.1 连接错误

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-000061] [Server] Aborted connection 123 to db: 'test' user: 'user' host: 'localhost'
```

**解决方案**：
```sql
-- 检查连接配置
SHOW VARIABLES LIKE 'max_connections';
SHOW VARIABLES LIKE 'wait_timeout';

-- 查看当前连接
SHOW PROCESSLIST;
```

#### 3.2.2 权限错误

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-000061] [Server] Access denied for user 'user'@'localhost'
```

**解决方案**：
```sql
-- 检查用户权限
SELECT User, Host FROM mysql.user WHERE User = 'user';

-- 授予权限
GRANT ALL PRIVILEGES ON database_name.* TO 'user'@'localhost';
FLUSH PRIVILEGES;
```

### 3.3 存储引擎错误

#### 3.3.1 InnoDB错误

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-012574] [InnoDB] Unable to lock ./ibdata1, error: 11
```

**解决方案**：
```bash
# 检查InnoDB文件
ls -la /var/lib/mysql/ibdata1

# 重启MySQL服务
systemctl restart mysql
```

#### 3.3.2 磁盘空间错误

```
2024-01-15T10:30:45.123456Z 0 [ERROR] [MY-012574] [InnoDB] Error writing file './ibdata1' (OS errno 28 - No space left on device)
```

**解决方案**：
```bash
# 检查磁盘空间
df -h

# 清理日志文件
find /var/log -name "*.log" -mtime +7 -delete
```

## 4. 错误日志分析

### 4.1 日志分析工具

#### 4.1.1 使用grep分析

```bash
# 查看错误信息
grep "ERROR" /var/log/mysql/error.log

# 查看特定时间段的错误
grep "2024-01-15" /var/log/mysql/error.log | grep "ERROR"

# 统计错误数量
grep -c "ERROR" /var/log/mysql/error.log
```

#### 4.1.2 使用awk分析

```bash
# 按错误类型统计
awk '/ERROR/ {print $NF}' /var/log/mysql/error.log | sort | uniq -c

# 按时间统计错误
awk '/ERROR/ {print $1}' /var/log/mysql/error.log | sort | uniq -c
```

#### 4.1.3 使用sed分析

```bash
# 提取错误信息
sed -n '/ERROR/p' /var/log/mysql/error.log

# 替换敏感信息
sed 's/password=.*/password=***/' /var/log/mysql/error.log
```

### 4.2 日志轮转

#### 4.2.1 手动轮转

```bash
# 重命名当前日志文件
mv /var/log/mysql/error.log /var/log/mysql/error.log.old

# 重新加载MySQL配置
mysqladmin flush-logs

# 压缩旧日志
gzip /var/log/mysql/error.log.old
```

#### 4.2.2 自动轮转

```bash
# 创建logrotate配置
cat > /etc/logrotate.d/mysql-error << EOF
/var/log/mysql/error.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 mysql mysql
    postrotate
        mysqladmin flush-logs
    endscript
}
EOF
```

## 5. 错误日志监控

### 5.1 监控脚本

```bash
#!/bin/bash
# 监控错误日志的脚本

ERROR_LOG="/var/log/mysql/error.log"
ALERT_EMAIL="admin@example.com"

# 检查错误数量
ERROR_COUNT=$(grep -c "ERROR" "$ERROR_LOG")

# 如果错误数量超过阈值，发送告警
if [ "$ERROR_COUNT" -gt 10 ]; then
    echo "MySQL错误日志告警: 发现 $ERROR_COUNT 个错误" | mail -s "MySQL错误告警" "$ALERT_EMAIL"
fi
```

### 5.2 实时监控

```bash
# 实时监控错误日志
tail -f /var/log/mysql/error.log | grep --line-buffered "ERROR"

# 监控特定错误
tail -f /var/log/mysql/error.log | grep --line-buffered "Access denied"
```

## 6. 错误日志最佳实践

### 6.1 配置最佳实践

```ini
# my.cnf 配置建议
[mysqld]
# 设置错误日志路径
log_error = /var/log/mysql/error.log

# 设置合适的错误级别
log_error_verbosity = 2

# 启用错误日志轮转
log_error_services = 'log_filter_internal; log_sink_internal'
```

### 6.2 监控最佳实践

1. **定期检查**：每天检查错误日志
2. **设置告警**：对严重错误设置告警
3. **日志轮转**：定期轮转和清理日志
4. **备份日志**：重要错误日志要备份

### 6.3 安全最佳实践

```bash
# 设置合适的文件权限
chmod 644 /var/log/mysql/error.log
chown mysql:mysql /var/log/mysql/error.log

# 避免在错误日志中记录敏感信息
# 在配置文件中使用变量而不是硬编码密码
```

## 7. 常见问题解决

### 7.1 错误日志文件过大

```bash
# 检查文件大小
ls -lh /var/log/mysql/error.log

# 轮转日志文件
mysqladmin flush-logs

# 清理旧日志
find /var/log/mysql -name "error.log.*" -mtime +30 -delete
```

### 7.2 错误日志权限问题

```bash
# 检查权限
ls -la /var/log/mysql/error.log

# 修复权限
chown mysql:mysql /var/log/mysql/error.log
chmod 644 /var/log/mysql/error.log
```

### 7.3 错误日志路径问题

```sql
-- 查看当前错误日志路径
SHOW VARIABLES LIKE 'log_error';

-- 修改错误日志路径
SET GLOBAL log_error = '/new/path/error.log';
```

## 8. 错误日志与其他日志的关系

### 8.1 错误日志与慢查询日志

```sql
-- 错误日志记录慢查询日志的启用/禁用
-- 慢查询日志记录具体的慢查询SQL
```

### 8.2 错误日志与二进制日志

```sql
-- 错误日志记录二进制日志的错误
-- 二进制日志记录数据变更
```

### 8.3 错误日志与一般查询日志

```sql
-- 错误日志记录查询日志的启用/禁用
-- 一般查询日志记录所有SQL语句
```

## 总结

MySQL错误日志是数据库运维的重要工具：

1. **配置管理**：正确配置错误日志路径和级别
2. **错误分析**：及时分析错误日志中的问题
3. **监控告警**：设置错误日志监控和告警
4. **日志维护**：定期轮转和清理错误日志
5. **安全考虑**：避免在错误日志中记录敏感信息

通过有效的错误日志管理，可以及时发现和解决MySQL运行中的问题，保证数据库的稳定运行。 