# MySQL 知识点大纲

## 1. MySQL 基础架构

### 1.1 整体架构

- **连接层**：处理客户端连接、认证、安全等
- **服务层**：查询解析、优化、缓存、存储过程等
- **引擎层**：可插拔存储引擎（InnoDB、MyISAM等）
- **存储层**：文件系统存储数据

### 1.2 核心组件

- **查询缓存**：缓存查询结果
- **分析器**：词法分析、语法分析
- **优化器**：生成执行计划
- **执行器**：调用存储引擎接口

### 1.3 存储引擎

- **InnoDB**：事务型存储引擎，支持ACID
- **MyISAM**：非事务型，表锁
- **Memory**：内存表
- **Archive**：归档存储
- **CSV**：CSV文件存储

## 2. MySQL 数据类型

### 2.1 数值类型

- **整数类型**：TINYINT、SMALLINT、MEDIUMINT、INT、BIGINT
- **浮点类型**：FLOAT、DOUBLE
- **定点类型**：DECIMAL

### 2.2 字符串类型

- **CHAR**：固定长度字符串
- **VARCHAR**：可变长度字符串
- **TEXT**：长文本
- **BLOB**：二进制大对象

### 2.3 日期时间类型

- **DATE**：日期
- **TIME**：时间
- **DATETIME**：日期时间
- **TIMESTAMP**：时间戳
- **YEAR**：年份

### 2.4 其他类型

- **ENUM**：枚举类型
- **SET**：集合类型
- **JSON**：JSON数据类型

## 3. MySQL 索引结构

### 3.1 索引类型

- **B+树索引**：最常用的索引类型
- **哈希索引**：Memory引擎支持
- **全文索引**：用于文本搜索
- **空间索引**：用于地理数据

### 3.2 索引分类

- **主键索引**：唯一且非空
- **唯一索引**：唯一值
- **普通索引**：允许重复值
- **复合索引**：多列组合索引
- **前缀索引**：字符串前缀索引

### 3.3 B+树索引原理

- **聚簇索引**：数据行与索引存储在一起
- **非聚簇索引**：索引与数据分离存储
- **回表查询**：通过非聚簇索引查找主键，再查数据

### 3.4 索引优化

- **索引选择性**：区分度高的列适合建索引
- **最左前缀原则**：复合索引的使用规则
- **索引覆盖**：查询列都在索引中
- **索引下推**：在存储引擎层过滤数据

## 4. MySQL 锁机制

### 4.1 锁的分类

- **按粒度分类**：
  - **表锁**：锁定整个表
  - **行锁**：锁定单行数据
  - **页锁**：锁定数据页

- **按性质分类**：
  - **共享锁（S锁）**：读锁，可共享
  - **排他锁（X锁）**：写锁，独占

### 4.2 InnoDB锁机制

- **意向锁**：表级锁，表示意图
- **记录锁**：锁定索引记录
- **间隙锁**：锁定索引记录之间的间隙
- **临键锁**：记录锁+间隙锁的组合
- **插入意向锁**：插入时的特殊锁

### 4.3 锁的兼容性

- **共享锁与共享锁**：兼容
- **共享锁与排他锁**：不兼容
- **排他锁与排他锁**：不兼容

### 4.4 死锁处理

- **死锁检测**：自动检测死锁
- **死锁预防**：按固定顺序访问资源
- **死锁恢复**：回滚事务

## 5. MySQL 事务管理

### 5.1 事务基础概念

- **事务定义**：一组原子性的SQL操作
- **事务边界**：BEGIN、COMMIT、ROLLBACK
- **事务特性**：ACID（原子性、一致性、隔离性、持久性）
- **事务状态**：活动、部分提交、失败、中止、提交

### 5.2 ACID特性详解

- **原子性（Atomicity）**：
  - 事务是不可分割的工作单位
  - 要么全部成功，要么全部失败
  - 通过Undo Log实现回滚

- **一致性（Consistency）**：
  - 事务执行前后数据库状态一致
  - 满足预定义的约束条件
  - 业务逻辑的一致性保证

- **隔离性（Isolation）**：
  - 并发事务之间相互隔离
  - 通过锁机制和MVCC实现
  - 不同隔离级别提供不同程度的隔离

- **持久性（Durability）**：
  - 事务提交后数据永久保存
  - 通过Redo Log实现持久性
  - 系统故障后数据不丢失

### 5.3 事务隔离级别

- **READ UNCOMMITTED（读未提交）**：
  - 最低隔离级别
  - 可能读取到未提交的数据（脏读）
  - 性能最好，但数据一致性最差

- **READ COMMITTED（读已提交）**：
  - 只能读取已提交的数据
  - 避免脏读，但可能出现不可重复读
  - Oracle默认隔离级别

- **REPEATABLE READ（可重复读）**：
  - 事务期间多次读取结果一致
  - 避免脏读和不可重复读
  - MySQL InnoDB默认隔离级别
  - 可能出现幻读

- **SERIALIZABLE（串行化）**：
  - 最高隔离级别
  - 完全串行执行，避免所有并发问题
  - 性能最差，但数据一致性最好

### 5.4 并发问题

- **脏读（Dirty Read）**：
  - 读取到未提交的数据
  - 在READ UNCOMMITTED级别可能出现

- **不可重复读（Non-repeatable Read）**：
  - 同一事务内多次读取结果不一致
  - 在READ COMMITTED级别可能出现

- **幻读（Phantom Read）**：
  - 同一事务内查询范围数据发生变化
  - 在REPEATABLE READ级别可能出现

- **丢失更新（Lost Update）**：
  - 两个事务同时更新同一数据
  - 后提交的事务覆盖了先提交的事务

### 5.5 MVCC（多版本并发控制）

- **MVCC原理**：
  - 为每行数据维护多个版本
  - 通过隐藏字段实现版本控制
  - 实现非阻塞的读操作

- **版本链**：
  - `DB_TRX_ID`：创建该版本的事务ID
  - `DB_ROLL_PTR`：回滚指针，指向上一个版本
  - `DB_ROW_ID`：隐藏主键

- **Read View**：
  - 事务创建时的快照
  - 包含活跃事务列表
  - 用于判断数据版本可见性

### 5.6 事务控制语句

- **事务开始**：

  ```sql
  START TRANSACTION;
  BEGIN;
  ```

- **事务提交**：

  ```sql
  COMMIT;
  ```

- **事务回滚**：

  ```sql
  ROLLBACK;
  ```

- **保存点**：

  ```sql
  SAVEPOINT savepoint_name;
  ROLLBACK TO SAVEPOINT savepoint_name;
  RELEASE SAVEPOINT savepoint_name;
  ```

### 5.7 事务最佳实践

- **事务设计原则**：
  - 事务要尽可能短小
  - 避免在事务中进行耗时操作
  - 合理设置事务隔离级别

- **死锁预防**：
  - 按固定顺序访问表和行
  - 避免长事务
  - 使用合适的锁策略

- **性能优化**：
  - 批量操作使用事务
  - 合理使用保存点
  - 监控事务执行时间

## 6. MySQL 优化

### 6.1 查询优化

- **EXPLAIN分析**：查看执行计划
- **索引优化**：合理使用索引
- **SQL优化**：避免SELECT *、使用LIMIT等
- **子查询优化**：转换为JOIN
- **分页优化**：使用游标分页

### 6.2 配置优化

- **内存配置**：
  - `innodb_buffer_pool_size`：InnoDB缓冲池
  - `key_buffer_size`：MyISAM索引缓冲
  - `query_cache_size`：查询缓存

- **连接配置**：
  - `max_connections`：最大连接数
  - `thread_cache_size`：线程缓存

### 6.3 表结构优化

- **字段类型选择**：选择合适的数据类型
- **范式设计**：避免数据冗余
- **分表策略**：水平分表、垂直分表
- **分区表**：按范围、列表、哈希分区

### 6.4 硬件优化

- **磁盘I/O优化**：使用SSD、RAID
- **内存优化**：增加内存容量
- **CPU优化**：多核处理器

## 7. MySQL 日志

### 7.1 错误日志

- **作用**：记录MySQL运行错误信息
- **配置**：`log_error`
- **查看**：`SHOW VARIABLES LIKE 'log_error'`

### 7.2 查询日志

- **作用**：记录所有SQL语句
- **配置**：`general_log`
- **性能影响**：影响性能，生产环境慎用

### 7.3 慢查询日志

- **作用**：记录执行时间超过阈值的SQL
- **配置**：
  - `slow_query_log`：开启慢查询日志
  - `long_query_time`：慢查询阈值
  - `log_queries_not_using_indexes`：记录未使用索引的查询

### 7.4 二进制日志（Binlog）

- **作用**：记录数据变更，用于主从复制和恢复
- **格式**：
  - **STATEMENT**：记录SQL语句
  - **ROW**：记录行数据变更
  - **MIXED**：混合模式
- **配置**：
  - `log_bin`：开启二进制日志
  - `binlog_format`：日志格式
  - `expire_logs_days`：日志保留天数

### 7.5 重做日志（Redo Log）

- **作用**：InnoDB事务日志，保证ACID
- **特点**：循环写入，固定大小
- **配置**：
  - `innodb_log_file_size`：日志文件大小
  - `innodb_log_files_in_group`：日志文件数量

### 7.6 撤销日志（Undo Log）

- **作用**：记录事务回滚信息
- **存储**：系统表空间或独立表空间
- **配置**：`innodb_undo_tablespaces`

## 8. MySQL 主从复制

### 8.1 复制原理

- **主库**：记录二进制日志
- **从库**：读取主库日志，重放执行
- **三个线程**：
  - **Binlog Dump**：主库发送日志
  - **I/O Thread**：从库接收日志
  - **SQL Thread**：从库重放日志

### 8.2 复制模式

- **异步复制**：默认模式，主库不等待从库
- **半同步复制**：主库等待至少一个从库接收
- **组复制**：多主复制，一致性保证

### 8.3 复制配置

- **主库配置**：

  ```sql
  server_id = 1
  log_bin = mysql-bin
  binlog_format = ROW
  ```

- **从库配置**：

  ```sql
  server_id = 2
  relay_log = mysql-relay-bin
  ```

### 8.4 复制监控

- **SHOW SLAVE STATUS**：查看从库状态
- **SHOW MASTER STATUS**：查看主库状态
- **延迟监控**：Seconds_Behind_Master

### 8.5 故障处理

- **网络中断**：自动重连
- **数据不一致**：重新同步
- **从库故障**：切换备用从库

## 9. MySQL 高级特性

### 9.1 临时表

- **内存临时表**：小数据量，内存存储
- **磁盘临时表**：大数据量，磁盘存储
- **使用场景**：
  - 复杂查询的中间结果
  - 排序和分组操作
  - 子查询优化

### 9.2 视图（View）

- **作用**：虚拟表，基于查询结果
- **类型**：
  - **普通视图**：基于单表或多表查询
  - **物化视图**：存储查询结果（MySQL不支持）
- **优点**：
  - 简化复杂查询
  - 数据安全性
  - 逻辑独立性

### 9.3 存储过程（Stored Procedure）

- **作用**：预编译的SQL语句集合
- **语法**：

  ```sql
  DELIMITER //
  CREATE PROCEDURE procedure_name(parameters)
  BEGIN
    -- SQL statements
  END //
  DELIMITER ;
  ```

- **优点**：
  - 提高性能
  - 减少网络传输
  - 增强安全性

### 9.4 触发器（Trigger）

- **作用**：在表数据变更时自动执行
- **类型**：
  - **BEFORE INSERT**：插入前触发
  - **AFTER INSERT**：插入后触发
  - **BEFORE UPDATE**：更新前触发
  - **AFTER UPDATE**：更新后触发
  - **BEFORE DELETE**：删除前触发
  - **AFTER DELETE**：删除后触发

- **语法**：

  ```sql
  CREATE TRIGGER trigger_name
  BEFORE/AFTER INSERT/UPDATE/DELETE
  ON table_name
  FOR EACH ROW
  BEGIN
    -- trigger logic
  END;
  ```

### 9.5 事件调度器（Event Scheduler）

- **作用**：定时执行SQL语句
- **配置**：`event_scheduler = ON`
- **语法**：

  ```sql
  CREATE EVENT event_name
  ON SCHEDULE schedule
  DO
    -- SQL statements
  ```

## 10. MySQL 安全与权限

### 10.1 用户管理

- **创建用户**：`CREATE USER`
- **删除用户**：`DROP USER`
- **修改密码**：`ALTER USER`

### 10.2 权限管理

- **授权**：`GRANT`
- **撤销权限**：`REVOKE`
- **权限级别**：
  - **全局权限**：影响所有数据库
  - **数据库权限**：影响指定数据库
  - **表权限**：影响指定表
  - **列权限**：影响指定列

### 10.3 安全配置

- **密码策略**：`validate_password`
- **连接限制**：`max_connections`
- **SSL连接**：加密传输

## 11. MySQL 监控与维护

### 11.1 性能监控

- **SHOW STATUS**：查看服务器状态
- **SHOW PROCESSLIST**：查看连接进程
- **SHOW ENGINE INNODB STATUS**：InnoDB状态
- **Performance Schema**：性能监控表

### 11.2 备份恢复

- **物理备份**：mysqldump、mysqlpump
- **逻辑备份**：复制数据文件
- **增量备份**：基于二进制日志
- **恢复策略**：全量+增量恢复

### 11.3 数据维护

- **表维护**：`OPTIMIZE TABLE`
- **索引维护**：`ANALYZE TABLE`
- **统计信息**：`ANALYZE TABLE`
- **碎片整理**：重建表结构

## 12. MySQL 高可用

### 12.1 主从切换

- **手动切换**：修改应用配置
- **自动切换**：使用代理工具
- **故障检测**：心跳检测

### 12.2 集群方案

- **MySQL Group Replication**：组复制
- **MySQL InnoDB Cluster**：InnoDB集群
- **MySQL NDB Cluster**：NDB集群

### 12.3 读写分离

- **应用层分离**：代码中区分读写
- **代理层分离**：使用代理工具
- **中间件**：MyCat、Sharding-JDBC

## 13. MySQL 版本特性

### 13.1 MySQL 8.0新特性

- **窗口函数**：分析函数支持
- **CTE**：公用表表达式
- **JSON增强**：JSON函数和索引
- **角色管理**：角色权限管理
- **原子DDL**：DDL操作原子性

### 13.2 MySQL 5.7特性

- **JSON数据类型**：原生JSON支持
- **Generated Columns**：生成列
- **InnoDB增强**：性能优化
- **复制增强**：多源复制

---

## 学习建议

1. **基础先行**：先掌握基础架构和数据类型
2. **实践为主**：多动手操作，理解原理
3. **性能优先**：重点关注索引和优化
4. **安全第一**：重视权限管理和安全配置
5. **持续学习**：关注新版本特性和最佳实践
