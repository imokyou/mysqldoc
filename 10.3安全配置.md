# MySQL 安全配置

## 概述

MySQL安全配置是保护数据库免受未授权访问和恶意攻击的重要措施。通过合理的安全配置，可以确保数据的机密性、完整性和可用性。本文档将详细介绍MySQL的安全配置策略和最佳实践。

## 密码安全策略

### 1. 密码复杂度要求

#### 1.1 密码验证插件配置
```sql
-- 安装密码验证插件
INSTALL PLUGIN validate_password SONAME 'validate_password.so';

-- 查看密码验证插件状态
SHOW PLUGINS LIKE 'validate_password';

-- 配置密码策略
SET GLOBAL validate_password.policy=MEDIUM;
SET GLOBAL validate_password.length=8;
SET GLOBAL validate_password.mixed_case_count=1;
SET GLOBAL validate_password.number_count=1;
SET GLOBAL validate_password.special_char_count=1;
```

#### 1.2 密码策略级别
- **LOW**：只检查密码长度
- **MEDIUM**：检查长度、数字、大小写字母
- **STRONG**：检查长度、数字、大小写字母、特殊字符

#### 1.3 密码复杂度参数
```sql
-- 密码最小长度
validate_password.length=8

-- 大写字母最小数量
validate_password.mixed_case_count=1

-- 数字最小数量
validate_password.number_count=1

-- 特殊字符最小数量
validate_password.special_char_count=1

-- 密码字典文件路径
validate_password.dictionary_file=/path/to/dictionary.txt
```

### 2. 密码过期策略

#### 2.1 设置密码过期时间
```sql
-- 设置用户密码90天后过期
ALTER USER 'user'@'localhost' PASSWORD EXPIRE INTERVAL 90 DAY;

-- 设置用户密码立即过期
ALTER USER 'user'@'localhost' PASSWORD EXPIRE;

-- 设置用户密码永不过期
ALTER USER 'user'@'localhost' PASSWORD EXPIRE NEVER;
```

#### 2.2 全局密码过期策略
```sql
-- 设置默认密码过期时间（天）
SET GLOBAL default_password_lifetime=90;

-- 禁用密码过期
SET GLOBAL default_password_lifetime=0;
```

### 3. 密码历史管理

#### 3.1 密码重用限制
```sql
-- 设置密码重用间隔（天）
SET GLOBAL password_history=10;

-- 设置密码重用间隔（天数）
SET GLOBAL password_reuse_interval=365;
```

## 连接安全配置

### 1. 连接限制

#### 1.1 最大连接数配置
```sql
-- 设置最大连接数
SET GLOBAL max_connections=200;

-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看最大连接数
SHOW VARIABLES LIKE 'max_connections';
```

#### 1.2 连接超时配置
```sql
-- 设置连接超时时间（秒）
SET GLOBAL connect_timeout=10;

-- 设置等待超时时间（秒）
SET GLOBAL wait_timeout=28800;

-- 设置交互超时时间（秒）
SET GLOBAL interactive_timeout=28800;
```

#### 1.3 连接来源限制
```sql
-- 创建用户时限制连接来源
CREATE USER 'user'@'192.168.1.%' IDENTIFIED BY 'password';

-- 限制用户只能从本地连接
CREATE USER 'user'@'localhost' IDENTIFIED BY 'password';

-- 限制用户只能从特定IP连接
CREATE USER 'user'@'192.168.1.100' IDENTIFIED BY 'password';
```

### 2. SSL/TLS 加密连接

#### 2.1 SSL 配置
```sql
-- 查看SSL状态
SHOW VARIABLES LIKE 'have_ssl';

-- 查看SSL证书信息
SHOW VARIABLES LIKE '%ssl%';

-- 强制使用SSL连接
ALTER USER 'user'@'localhost' REQUIRE SSL;

-- 要求特定加密套件
ALTER USER 'user'@'localhost' REQUIRE CIPHER 'DHE-RSA-AES256-SHA';
```

#### 2.2 SSL 证书配置
```ini
# my.cnf 配置文件
[mysqld]
ssl-ca=/path/to/ca.pem
ssl-cert=/path/to/server-cert.pem
ssl-key=/path/to/server-key.pem
ssl-cipher=DHE-RSA-AES256-SHA
```

### 3. 网络访问控制

#### 3.1 防火墙配置
```bash
# 限制MySQL端口访问
iptables -A INPUT -p tcp --dport 3306 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j DROP

# 使用ufw（Ubuntu）
ufw allow from 192.168.1.0/24 to any port 3306
```

#### 3.2 MySQL 绑定地址
```ini
# my.cnf 配置文件
[mysqld]
bind-address=192.168.1.100
```

## 审计和日志

### 1. 审计插件配置

#### 1.1 安装审计插件
```sql
-- 安装审计插件
INSTALL PLUGIN audit_log SONAME 'audit_log.so';

-- 查看审计插件状态
SHOW PLUGINS LIKE 'audit_log';
```

#### 1.2 审计配置
```ini
# my.cnf 配置文件
[mysqld]
audit_log=FORCE_PLUS_PERMANENT
audit_log_file=/var/log/mysql/audit.log
audit_log_format=JSON
audit_log_policy=LOGINS
```

#### 1.3 审计策略
- **ALL**：记录所有事件
- **LOGINS**：只记录登录事件
- **QUERIES**：只记录查询事件
- **NONE**：不记录任何事件

### 2. 安全日志配置

#### 2.1 错误日志
```ini
# my.cnf 配置文件
[mysqld]
log_error=/var/log/mysql/error.log
log_error_verbosity=2
```

#### 2.2 查询日志
```ini
# my.cnf 配置文件
[mysqld]
general_log=1
general_log_file=/var/log/mysql/query.log
log_output=FILE
```

#### 2.3 慢查询日志
```ini
# my.cnf 配置文件
[mysqld]
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=2
log_queries_not_using_indexes=1
```

## 数据安全

### 1. 数据加密

#### 1.1 表空间加密
```sql
-- 创建加密表空间
CREATE TABLESPACE encrypted_tablespace
ADD DATAFILE 'encrypted_tablespace.ibd'
ENCRYPTION='Y';

-- 在加密表空间中创建表
CREATE TABLE encrypted_table (
    id INT PRIMARY KEY,
    data VARCHAR(255)
) TABLESPACE encrypted_tablespace;
```

#### 1.2 列级加密
```sql
-- 使用AES加密函数
INSERT INTO users (id, encrypted_data) 
VALUES (1, AES_ENCRYPT('sensitive_data', 'encryption_key'));

-- 解密数据
SELECT id, AES_DECRYPT(encrypted_data, 'encryption_key') as decrypted_data 
FROM users;
```

### 2. 备份安全

#### 2.1 加密备份
```bash
# 使用mysqldump创建加密备份
mysqldump --single-transaction --routines --triggers \
    --all-databases | gzip | openssl enc -aes-256-cbc \
    -k 'backup_password' > backup.sql.gz.enc

# 解密备份
openssl enc -aes-256-cbc -d -k 'backup_password' \
    -in backup.sql.gz.enc | gunzip > backup.sql
```

#### 2.2 备份文件权限
```bash
# 设置备份文件权限
chmod 600 /path/to/backup.sql
chown mysql:mysql /path/to/backup.sql
```

## 系统安全

### 1. 操作系统安全

#### 1.1 文件权限
```bash
# 设置MySQL数据目录权限
chown -R mysql:mysql /var/lib/mysql
chmod 750 /var/lib/mysql

# 设置配置文件权限
chown mysql:mysql /etc/mysql/my.cnf
chmod 644 /etc/mysql/my.cnf
```

#### 1.2 进程安全
```bash
# 限制MySQL进程资源
ulimit -n 65535
ulimit -u 2000
```

### 2. 网络安全

#### 2.1 VPN 连接
```bash
# 配置VPN隧道
# 使用OpenVPN或其他VPN解决方案
# 确保MySQL只通过VPN访问
```

#### 2.2 代理配置
```ini
# 使用代理服务器
# 配置nginx或haproxy作为MySQL代理
```

## 安全监控

### 1. 实时监控

#### 1.1 连接监控
```sql
-- 查看当前连接
SHOW PROCESSLIST;

-- 查看连接统计
SHOW STATUS LIKE 'Threads_%';

-- 查看连接来源
SELECT user, host, db, command, time, state 
FROM information_schema.processlist;
```

#### 1.2 权限监控
```sql
-- 查看用户权限变更
SELECT * FROM mysql.user WHERE User != 'root';

-- 查看最近登录的用户
SELECT user, host, last_update 
FROM mysql.user 
ORDER BY last_update DESC;
```

### 2. 安全扫描

#### 2.1 漏洞扫描
```bash
# 使用MySQL安全扫描工具
mysql_secure_installation

# 使用专业安全扫描工具
# 如Nessus、OpenVAS等
```

#### 2.2 配置检查
```sql
-- 检查不安全配置
SHOW VARIABLES LIKE 'skip_%';
SHOW VARIABLES LIKE 'local_infile';
SHOW VARIABLES LIKE 'sql_mode';
```

## 应急响应

### 1. 安全事件处理

#### 1.1 入侵检测
```sql
-- 检查异常登录
SELECT user, host, last_update 
FROM mysql.user 
WHERE last_update > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查异常查询
SELECT * FROM mysql.general_log 
WHERE event_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)
AND argument LIKE '%DROP%' OR argument LIKE '%DELETE%';
```

#### 1.2 应急措施
```sql
-- 立即锁定可疑用户
ALTER USER 'suspicious_user'@'%' ACCOUNT LOCK;

-- 撤销可疑用户权限
REVOKE ALL PRIVILEGES ON *.* FROM 'suspicious_user'@'%';

-- 删除可疑用户
DROP USER 'suspicious_user'@'%';
```

### 2. 恢复策略

#### 2.1 数据恢复
```bash
# 从备份恢复数据
mysql -u root -p < backup.sql

# 使用二进制日志恢复
mysqlbinlog --start-datetime="2023-01-01 10:00:00" \
    --stop-datetime="2023-01-01 11:00:00" \
    mysql-bin.000001 | mysql -u root -p
```

#### 2.2 系统恢复
```bash
# 重新安装MySQL
# 恢复配置文件
# 恢复数据文件
# 重新配置安全设置
```

## 最佳实践总结

### 1. 安全配置清单

- [ ] 安装并配置密码验证插件
- [ ] 设置强密码策略
- [ ] 配置密码过期时间
- [ ] 限制连接来源
- [ ] 启用SSL/TLS加密
- [ ] 配置防火墙规则
- [ ] 启用审计日志
- [ ] 配置数据加密
- [ ] 设置文件权限
- [ ] 建立监控机制

### 2. 定期安全检查

- [ ] 每月检查用户权限
- [ ] 每周检查日志文件
- [ ] 每月更新安全补丁
- [ ] 每季度进行安全审计
- [ ] 每年进行渗透测试

### 3. 安全培训

- [ ] 定期进行安全培训
- [ ] 建立安全操作规范
- [ ] 制定应急响应计划
- [ ] 建立安全责任制度

通过以上安全配置措施，可以显著提高MySQL数据库的安全性，保护数据免受各种威胁。 

**[返回目录 README.md](./README?id=_10-mysql-安全与权限)** 