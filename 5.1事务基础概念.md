# 5.1 事务基础概念

## 概述

事务（Transaction）是数据库管理系统中的一个重要概念，它是一组原子性的SQL操作，这些操作要么全部成功执行，要么全部失败回滚。事务确保了数据库的一致性和完整性。

## 事务定义

### 什么是事务

事务是数据库操作的一个逻辑单元，它包含一个或多个SQL语句，这些语句作为一个整体被执行。事务具有以下特点：

- **原子性**：事务中的所有操作要么全部成功，要么全部失败
- **一致性**：事务执行前后数据库状态保持一致
- **隔离性**：并发事务之间相互隔离
- **持久性**：事务提交后数据永久保存

### 事务的边界

事务有明确的开始和结束边界：

```sql
-- 事务开始
START TRANSACTION;
-- 或者
BEGIN;

-- 事务中的SQL操作
INSERT INTO users (name, email) VALUES ('张三', 'zhangsan@example.com');
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE user_id = 2;

-- 事务结束（提交或回滚）
COMMIT;  -- 提交事务
-- 或者
ROLLBACK;  -- 回滚事务
```

## 事务特性（ACID）

### 原子性（Atomicity）

原子性确保事务是不可分割的工作单位。事务中的所有操作要么全部成功执行，要么全部失败回滚。

**示例：**
```sql
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE user_id = 2;
-- 如果任何一步失败，整个事务都会回滚
COMMIT;
```

### 一致性（Consistency）

一致性确保事务执行前后数据库状态保持一致，满足预定义的约束条件。

**示例：**
```sql
-- 转账事务必须保持总金额不变
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE user_id = 2;
-- 确保总金额在事务前后保持一致
COMMIT;
```

### 隔离性（Isolation）

隔离性确保并发事务之间相互隔离，一个事务的执行不会受到其他事务的影响。

**示例：**
```sql
-- 事务A
START TRANSACTION;
SELECT balance FROM accounts WHERE user_id = 1;
-- 事务B不会看到事务A未提交的修改
```

### 持久性（Durability）

持久性确保事务提交后数据永久保存，即使系统故障也不会丢失。

**示例：**
```sql
START TRANSACTION;
INSERT INTO orders (user_id, amount) VALUES (1, 100);
COMMIT;
-- 提交后数据永久保存，系统重启后数据仍然存在
```

## 事务状态

事务在其生命周期中会经历不同的状态：

### 1. 活动状态（Active）

事务正在执行中，可以执行SQL操作。

```sql
START TRANSACTION;  -- 事务进入活动状态
INSERT INTO users (name) VALUES ('李四');
-- 事务处于活动状态
```

### 2. 部分提交状态（Partially Committed）

事务的最后一个操作执行完成，但还没有提交。

```sql
START TRANSACTION;
INSERT INTO users (name) VALUES ('李四');
UPDATE accounts SET balance = balance + 50 WHERE user_id = 1;
-- 此时事务处于部分提交状态
```

### 3. 失败状态（Failed）

事务执行过程中遇到错误，无法继续执行。

```sql
START TRANSACTION;
INSERT INTO users (name) VALUES ('李四');
INSERT INTO users (name) VALUES (NULL);  -- 违反约束，事务进入失败状态
```

### 4. 中止状态（Aborted）

事务回滚完成，数据库恢复到事务开始前的状态。

```sql
START TRANSACTION;
INSERT INTO users (name) VALUES ('李四');
ROLLBACK;  -- 事务进入中止状态，所有修改被撤销
```

### 5. 提交状态（Committed）

事务成功提交，所有修改永久保存。

```sql
START TRANSACTION;
INSERT INTO users (name) VALUES ('李四');
COMMIT;  -- 事务进入提交状态，修改永久保存
```

## 事务控制语句

### 开始事务

```sql
-- 方式1：使用START TRANSACTION
START TRANSACTION;

-- 方式2：使用BEGIN
BEGIN;

-- 方式3：使用BEGIN WORK
BEGIN WORK;
```

### 提交事务

```sql
-- 提交当前事务
COMMIT;

-- 提交并释放所有锁
COMMIT AND CHAIN;

-- 提交并开始新事务
COMMIT AND RELEASE;
```

### 回滚事务

```sql
-- 回滚整个事务
ROLLBACK;

-- 回滚到指定保存点
ROLLBACK TO SAVEPOINT savepoint_name;

-- 回滚并释放所有锁
ROLLBACK AND CHAIN;
```

### 保存点（Savepoint）

保存点允许在事务内部创建回滚点。

```sql
START TRANSACTION;
INSERT INTO users (name) VALUES ('张三');
SAVEPOINT sp1;  -- 创建保存点
INSERT INTO users (name) VALUES ('李四');
SAVEPOINT sp2;  -- 创建另一个保存点
INSERT INTO users (name) VALUES ('王五');

-- 回滚到sp2
ROLLBACK TO SAVEPOINT sp2;

-- 回滚到sp1
ROLLBACK TO SAVEPOINT sp1;

-- 释放保存点
RELEASE SAVEPOINT sp1;
```

## 自动提交模式

MySQL默认启用自动提交模式，每个SQL语句都会自动提交。

### 查看自动提交状态

```sql
SHOW VARIABLES LIKE 'autocommit';
```

### 禁用自动提交

```sql
SET autocommit = 0;
```

### 启用自动提交

```sql
SET autocommit = 1;
```

## 事务示例

### 银行转账示例

```sql
-- 开始转账事务
START TRANSACTION;

-- 检查账户余额
SELECT balance FROM accounts WHERE user_id = 1;
SELECT balance FROM accounts WHERE user_id = 2;

-- 执行转账操作
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE user_id = 2;

-- 验证转账结果
SELECT balance FROM accounts WHERE user_id = 1;
SELECT balance FROM accounts WHERE user_id = 2;

-- 提交事务
COMMIT;
```

### 订单处理示例

```sql
START TRANSACTION;

-- 创建订单
INSERT INTO orders (user_id, total_amount) VALUES (1, 150.00);

-- 获取订单ID
SET @order_id = LAST_INSERT_ID();

-- 添加订单项
INSERT INTO order_items (order_id, product_id, quantity, price) 
VALUES (@order_id, 101, 2, 50.00);
INSERT INTO order_items (order_id, product_id, quantity, price) 
VALUES (@order_id, 102, 1, 50.00);

-- 更新库存
UPDATE products SET stock = stock - 2 WHERE product_id = 101;
UPDATE products SET stock = stock - 1 WHERE product_id = 102;

-- 提交事务
COMMIT;
```

## 事务最佳实践

### 1. 事务设计原则

- **事务要尽可能短小**：减少锁持有时间
- **避免在事务中进行耗时操作**：如网络请求、文件操作
- **合理设置事务隔离级别**：根据业务需求选择

### 2. 错误处理

```sql
START TRANSACTION;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
    ROLLBACK;
    RESIGNAL;
END;

-- 事务操作
INSERT INTO users (name) VALUES ('张三');
UPDATE accounts SET balance = balance + 100 WHERE user_id = 1;

COMMIT;
```

### 3. 性能考虑

- **批量操作使用事务**：提高性能
- **合理使用保存点**：避免大事务回滚
- **监控事务执行时间**：及时发现性能问题

## 总结

事务是数据库管理系统的核心概念，它通过ACID特性确保数据的一致性和完整性。理解事务的基础概念对于开发可靠的数据库应用程序至关重要。在实际应用中，需要根据业务需求合理设计事务，并注意性能优化。 

**[返回目录 README.md](./README?id=_5-mysql-事务管理)** 